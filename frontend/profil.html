<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profil Postulateur</title>
<link rel="stylesheet" href="./profil.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<header>
  <h1>Dashboard Postulateur</h1>
  <div class="profile">
    <span id="proName">Nom Pr√©nom</span>
  </div>
</header>

<div class="container">
  <nav>
    <h2>Gestion</h2>
    <button id="viewProfileBtn"><i class="fa-solid fa-user"></i> Mon profil</button>
    <button id="manageAvailabilityBtn"><i class="fa-solid fa-calendar-check"></i> Disponibilit√©s</button>
    <button id="viewReservationsBtn"><i class="fa-solid fa-book"></i> Mes R√©servations</button>
  </nav>

  <main>
    <!-- Profil -->
    <div id="profileSection">
      <h2 class="section-title">Mon Profil</h2>
      <div class="profile-grid">
        <div class="profile-card"><h3>Nom</h3><p id="profileNameCard"></p></div>
        <div class="profile-card"><h3>Email</h3><p id="profileEmail"></p></div>
        <div class="profile-card"><h3>M√©tier</h3><p id="profileJob"></p></div>
        <div class="profile-card"><h3>Ville</h3><p id="profileLocation"></p></div>
        <div class="profile-card description-card"><h3>Description</h3><p id="profileDesc"></p></div>
      </div>
    </div>

    <!-- Disponibilit√©s -->
    <div id="availabilitySection" style="display:none;">
      <h2 class="section-title">Mes Disponibilit√©s</h2>
      <div class="calendar-controls">
        <label>Mois : <select id="monthSelect"></select></label>
        <label>Ann√©e : <select id="yearSelect"></select></label>
      </div>
      <div class="calendar" id="calendar"></div>
      <button id="saveAvailability" style="margin-top:15px;padding:10px 20px;background:#6a11cb;color:white;border:none;border-radius:5px;cursor:pointer;">Enregistrer disponibilit√©s</button>
    </div>

    <!-- R√©servations -->
    <div id="reservationsSection" style="display:none;">
      <h2 class="section-title">Mes R√©servations</h2>
      <div id="reservationsList"><p>Aucune r√©servation pour le moment.</p></div>
    </div>
  </main>
</div>

<script>
// üîπ Backend URL
const BASE_URL = "https://rendezy-backend-04a0b37d0bd1.herokuapp.com";

// üîπ R√©cup√©ration des donn√©es
let proData = null;

// Fonction pour charger les donn√©es depuis localStorage ou API
async function loadProfessionalData() {
  // D'abord essayer depuis localStorage
  const storedData = localStorage.getItem("proData");
  if (storedData) {
    proData = JSON.parse(storedData);
    console.log("Donn√©es depuis localStorage:", proData);
    updateProfileUI(proData);
  }
  
  // Ensuite v√©rifier via API si proId existe
  const proId = localStorage.getItem("proId");
  
  if (proId && !proData) {
    try {
      const response = await fetch(`${BASE_URL}/api/professionals/${proId}`);
      
      if (response.ok) {
        const apiData = await response.json();
        console.log("Donn√©es depuis API:", apiData);
        
        // Stocker les donn√©es API dans localStorage
        localStorage.setItem("proData", JSON.stringify(apiData));
        proData = apiData;
        updateProfileUI(proData);
      } else {
        console.warn("API non disponible, utilisation des donn√©es locales");
      }
    } catch (error) {
      console.error("Erreur API:", error);
      // Continuer avec les donn√©es locales si API √©choue
    }
  }
  
  // Si aucune donn√©e n'est disponible
  if (!proData) {
    document.getElementById('proName').innerText = "Veuillez vous connecter";
    document.getElementById('profileNameCard').innerText = "Donn√©es non disponibles";
    document.getElementById('profileEmail').innerText = "-";
    document.getElementById('profileJob').innerText = "-";
    document.getElementById('profileLocation').innerText = "-";
    document.getElementById('profileDesc').innerText = "-";
  }
}

// Fonction pour mettre √† jour l'interface
function updateProfileUI(data) {
  if (!data) return;
  
  // Nom complet
  const fullName = `${data.firstName || ''} ${data.lastName || ''}`.trim();
  document.getElementById('profileNameCard').innerText = fullName || "Non sp√©cifi√©";
  document.getElementById('proName').innerText = fullName || "Profil";
  
  // Email
  document.getElementById('profileEmail').innerText = data.email || "Non sp√©cifi√©";
  
  // M√©tier et sp√©cialit√©
  const jobText = data.service ? 
    `${data.service}${data.specialty ? " - " + data.specialty : ""}` : 
    "Non sp√©cifi√©";
  document.getElementById('profileJob').innerText = jobText;
  
  // Ville
  document.getElementById('profileLocation').innerText = data.location || "Non sp√©cifi√©";
  
  // Description
  document.getElementById('profileDesc').innerText = data.description || "Aucune description";
}

// Navigation
const profileSection = document.getElementById('profileSection');
const availabilitySection = document.getElementById('availabilitySection');
const reservationsSection = document.getElementById('reservationsSection');

document.getElementById('viewProfileBtn').addEventListener('click', () => {
  profileSection.style.display = 'block';
  availabilitySection.style.display = 'none';
  reservationsSection.style.display = 'none';
});

document.getElementById('manageAvailabilityBtn').addEventListener('click', () => {
  profileSection.style.display = 'none';
  availabilitySection.style.display = 'block';
  reservationsSection.style.display = 'none';
  loadAvailability(); // Charger les disponibilit√©s si besoin
});

document.getElementById('viewReservationsBtn').addEventListener('click', () => {
  profileSection.style.display = 'none';
  availabilitySection.style.display = 'none';
  reservationsSection.style.display = 'block';
  loadReservations(); // Charger les r√©servations si besoin
});

// Charger les donn√©es au d√©marrage
document.addEventListener('DOMContentLoaded', loadProfessionalData);

// Calendrier disponibilit√©s
const monthSelect = document.getElementById('monthSelect');
const yearSelect = document.getElementById('yearSelect');
const calendarEl = document.getElementById('calendar');
const months = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
const today = new Date();
let selectedMonth = today.getMonth();
let selectedYear = today.getFullYear();
let selectedDays = [];

function populateMonthYear() {
  // Nettoyer les selects
  monthSelect.innerHTML = '';
  yearSelect.innerHTML = '';
  
  // Remplir les mois
  months.forEach((m, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = m;
    if (i === selectedMonth) opt.selected = true;
    monthSelect.appendChild(opt);
  });
  
  // Remplir les ann√©es (5 ans √† partir de l'ann√©e actuelle)
  for (let y = today.getFullYear(); y <= today.getFullYear() + 5; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.text = y;
    if (y === selectedYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}

function renderCalendar(month, year) {
  calendarEl.innerHTML = '';
  
  // Ajouter les jours de la semaine
  const weekdays = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
  weekdays.forEach(d => {
    const wd = document.createElement('div');
    wd.className = 'weekday';
    wd.innerText = d;
    calendarEl.appendChild(wd);
  });
  
  // Calculer le premier jour du mois
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  // Ajuster pour commencer le lundi
  let start = firstDay === 0 ? 6 : firstDay - 1;
  
  // Cases vides avant le premier jour
  for (let i = 0; i < start; i++) {
    calendarEl.appendChild(document.createElement('div'));
  }
  
  // Cases des jours du mois
  for (let i = 1; i <= daysInMonth; i++) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day';
    dayDiv.innerText = i;
    
    // V√©rifier si le jour est s√©lectionn√©
    if (selectedDays.includes(i)) {
      dayDiv.classList.add('selected');
    }
    
    // G√©rer le clic sur un jour
    dayDiv.addEventListener('click', () => {
      if (dayDiv.classList.contains('selected')) {
        dayDiv.classList.remove('selected');
        selectedDays = selectedDays.filter(d => d !== i);
      } else {
        dayDiv.classList.add('selected');
        selectedDays.push(i);
      }
    });
    
    calendarEl.appendChild(dayDiv);
  }
}

// √âv√©nements pour les changements de mois/ann√©e
monthSelect.addEventListener('change', e => {
  selectedMonth = parseInt(e.target.value);
  renderCalendar(selectedMonth, selectedYear);
});

yearSelect.addEventListener('change', e => {
  selectedYear = parseInt(e.target.value);
  renderCalendar(selectedMonth, selectedYear);
});

// Sauvegarder les disponibilit√©s
document.getElementById('saveAvailability').addEventListener('click', () => {
  const proId = localStorage.getItem("proId");
  
  if (!proId) {
    alert("Veuillez d'abord cr√©er un profil");
    return;
  }
  
  // Pr√©parer les donn√©es
  const availabilityData = {
    professionalId: proId,
    month: selectedMonth + 1, // +1 car les mois commencent √† 0 en JS
    year: selectedYear,
    availableDays: selectedDays
  };
  
  console.log("Disponibilit√©s √† enregistrer:", availabilityData);
  
  // Ici, vous pouvez envoyer les donn√©es au backend
  // fetch(`${BASE_URL}/api/availability`, { ... })
  
  alert(`Disponibilit√©s enregistr√©es pour ${selectedDays.length} jour(s) !`);
});

// Fonctions pour charger les disponibilit√©s et r√©servations
function loadAvailability() {
  // √Ä impl√©menter: charger depuis l'API
  console.log("Chargement des disponibilit√©s...");
}

function loadReservations() {
  // √Ä impl√©menter: charger depuis l'API
  console.log("Chargement des r√©servations...");
}

// Initialiser le calendrier
populateMonthYear();
renderCalendar(selectedMonth, selectedYear);
</script>
</body>
</html>