<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profil Postulateur</title>
<link rel="stylesheet" href="./profil.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<header>
  <h1>Dashboard Postulateur</h1>
  <div class="profile">
    <span id="proName">Nom Pr√©nom</span>
  </div>
</header>

<div class="container">
  <nav>
    <h2>Gestion</h2>
    <button id="viewProfileBtn"><i class="fa-solid fa-user"></i> Mon profil</button>
    <button id="manageAvailabilityBtn"><i class="fa-solid fa-calendar-check"></i> Disponibilit√©s</button>
    <button id="viewReservationsBtn"><i class="fa-solid fa-book"></i> Mes R√©servations</button>
  </nav>

  <main>
    <!-- Profil -->
    <div id="profileSection">
      <h2 class="section-title">Mon Profil</h2>
      <div class="profile-grid">
        <div class="profile-card"><h3>Nom</h3><p id="profileNameCard"></p></div>
        <div class="profile-card"><h3>Email</h3><p id="profileEmail"></p></div>
        <div class="profile-card"><h3>M√©tier</h3><p id="profileJob"></p></div>
        <div class="profile-card"><h3>Ville</h3><p id="profileLocation"></p></div>
        <div class="profile-card description-card"><h3>Description</h3><p id="profileDesc"></p></div>
      </div>
    </div>

    <!-- Disponibilit√©s -->
    <div id="availabilitySection" style="display:none;">
      <h2 class="section-title">Mes Disponibilit√©s</h2>
      <div class="calendar-controls">
        <label>Mois : <select id="monthSelect"></select></label>
        <label>Ann√©e : <select id="yearSelect"></select></label>
      </div>
      <div class="calendar" id="calendar"></div>
      <button id="saveAvailability" style="margin-top:15px;padding:10px 20px;background:#6a11cb;color:white;border:none;border-radius:5px;cursor:pointer;">Enregistrer disponibilit√©s</button>
    </div>

    <!-- R√©servations -->
    <div id="reservationsSection" style="display:none;">
      <h2 class="section-title">Mes R√©servations</h2>
      <div id="reservationsList"><p>Aucune r√©servation pour le moment.</p></div>
    </div>
  </main>
</div>

<script>
const BASE_URL = "https://rendezy-backend-04a0b37d0bd1.herokuapp.com";

let proData = null;

// üîπ Mettre √† jour l'affichage du profil
function updateProfileUI(data) {
  if (!data) return;

  const fullName = `${data.firstName || ''} ${data.lastName || ''}`.trim();
  document.getElementById('profileNameCard').innerText = fullName || "Non sp√©cifi√©";
  document.getElementById('proName').innerText = fullName || "Profil";

  document.getElementById('profileEmail').innerText = data.email || "Non sp√©cifi√©";

  const jobText = data.service ? `${data.service}${data.specialty ? " - " + data.specialty : ""}` : "Non sp√©cifi√©";
  document.getElementById('profileJob').innerText = jobText;

  document.getElementById('profileLocation').innerText = data.location || "Non sp√©cifi√©";

  document.getElementById('profileDesc').innerText = data.description || "Aucune description";
}

// üîπ Charger les donn√©es depuis localStorage ou API
async function loadProfessionalData() {
  const storedData = localStorage.getItem("proData");
  const proId = localStorage.getItem("proId");

  if (storedData) {
    proData = JSON.parse(storedData);
    updateProfileUI(proData);
  }

  if (proId) {
    try {
      const response = await fetch(`${BASE_URL}/api/professionals/${proId}`);
      if (response.ok) {
        const apiData = await response.json();
        localStorage.setItem("proData", JSON.stringify(apiData));
        proData = apiData;
        updateProfileUI(proData);
      } 
    } catch (err) {
      console.error("Erreur API:", err);
    }
  }

  // Si aucune donn√©e dispo
  if (!proData) {
    document.getElementById('proName').innerText = "Veuillez vous connecter";
    document.getElementById('profileNameCard').innerText = "Donn√©es non disponibles";
    document.getElementById('profileEmail').innerText = "-";
    document.getElementById('profileJob').innerText = "-";
    document.getElementById('profileLocation').innerText = "-";
    document.getElementById('profileDesc').innerText = "-";
  }
}

// üîπ Navigation
const profileSection = document.getElementById('profileSection');
const availabilitySection = document.getElementById('availabilitySection');
const reservationsSection = document.getElementById('reservationsSection');

document.getElementById('viewProfileBtn').addEventListener('click', () => {
  profileSection.style.display = 'block';
  availabilitySection.style.display = 'none';
  reservationsSection.style.display = 'none';
});

document.getElementById('manageAvailabilityBtn').addEventListener('click', () => {
  profileSection.style.display = 'none';
  availabilitySection.style.display = 'block';
  reservationsSection.style.display = 'none';
});

document.getElementById('viewReservationsBtn').addEventListener('click', () => {
  profileSection.style.display = 'none';
  availabilitySection.style.display = 'none';
  reservationsSection.style.display = 'block';
});

// üîπ Calendrier disponibilit√©s (inchang√©)
const monthSelect = document.getElementById('monthSelect');
const yearSelect = document.getElementById('yearSelect');
const calendarEl = document.getElementById('calendar');
const months = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
const today = new Date();
let selectedMonth = today.getMonth();
let selectedYear = today.getFullYear();
let selectedDays = [];

function populateMonthYear() {
  monthSelect.innerHTML = '';
  yearSelect.innerHTML = '';
  months.forEach((m, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.text = m;
    if(i===selectedMonth) opt.selected=true;
    monthSelect.appendChild(opt);
  });
  for(let y=today.getFullYear(); y<=today.getFullYear()+5; y++){
    const opt = document.createElement('option');
    opt.value=y;
    opt.text=y;
    if(y===selectedYear) opt.selected=true;
    yearSelect.appendChild(opt);
  }
}

function renderCalendar(month, year) {
  calendarEl.innerHTML='';
  const weekdays=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
  weekdays.forEach(d=>{
    const wd=document.createElement('div');
    wd.className='weekday';
    wd.innerText=d;
    calendarEl.appendChild(wd);
  });
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  let start = firstDay===0?6:firstDay-1;
  for(let i=0;i<start;i++) calendarEl.appendChild(document.createElement('div'));
  for(let i=1;i<=daysInMonth;i++){
    const dayDiv=document.createElement('div');
    dayDiv.className='day';
    dayDiv.innerText=i;
    if(selectedDays.includes(i)) dayDiv.classList.add('selected');
    dayDiv.addEventListener('click',()=>{
      if(dayDiv.classList.contains('selected')){
        dayDiv.classList.remove('selected');
        selectedDays=selectedDays.filter(d=>d!==i);
      } else {
        dayDiv.classList.add('selected');
        selectedDays.push(i);
      }
    });
    calendarEl.appendChild(dayDiv);
  }
}

monthSelect.addEventListener('change', e=>{
  selectedMonth=parseInt(e.target.value);
  renderCalendar(selectedMonth, selectedYear);
});

yearSelect.addEventListener('change', e=>{
  selectedYear=parseInt(e.target.value);
  renderCalendar(selectedMonth, selectedYear);
});

document.getElementById('saveAvailability').addEventListener('click', ()=>{
  const proId = localStorage.getItem("proId");
  if(!proId) return alert("Veuillez d'abord cr√©er un profil");
  alert(`Disponibilit√©s enregistr√©es pour ${selectedDays.length} jour(s) !`);
});

// Charger les donn√©es au d√©marrage
document.addEventListener('DOMContentLoaded', loadProfessionalData);
populateMonthYear();
renderCalendar(selectedMonth, selectedYear);
</script>
</body>
</html>
